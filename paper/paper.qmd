---
title: "Survival Compass"
subtitle: "Statistical Insights into Lung Cancer Patients Journey Post Diagnosis"
author: 
  - Lexi Knight
thanks: "Code and data are available at: https://github.com/LexiKnight/Lung_Cancer/tree/main"
date: today
date-format: long 
abstract: "This study investigates the impact of pathologic stage and treatment modalities on lung cancer survival post-diagnosis. Analysis of patient data reveals significant correlation between pathologic stage, seeking treatment and survival outcomes. Notably, patients at advanced stages with metastases in distant sites beyond the lung, extensive lymph node involvement and tumors with extensive growth, invading nearby structures demonstrate lower survival rates. These findings underscore the critical importance of early detection, tailored treatment strategies and ongoing research efforts to enhance lung cancer survival rates globally."
format:
  pdf:
    toc: true
number-sections: true
bibliography: references.bib
---

# Introduction

Clinging to life amidst the shadows of lung cancer, where every breath becomes a battleground. Survival becomes not just a statistic but an interplay between several individual characteristics. We explore the hidden keys to defying the odds and emerging victorious against one of the deadliest adversaries of our time. Lung cancer is the leading cause of cancer-related deaths in the world [@Park]. It is a disease that develops in the lining of the airways in lung tissues. Non-small cell lung cancer (NSCLC) is the most common type, accounting for  80-85% of all lung cancers according to the American Cancer society [@Markman]. Staging is important for prognosis and making treatment decisions. Common treatments include surgery, radiation therapy and chemotherapy [@Kai]. pathologic stage is determined by presence of nearby metastasis, lymph node involvement as well as tumor spread and size [@Markman]. This paper investigates the relationship between lung cancer patients' survival and pathologic stage. The estimand is the median survival time in days post-diagnosis. We also look at whether patients decided to have treatment and if so, which method; radiation therapy or chemotherapy. Through analysis of a dataset made up of  981 patients in Sydney, Australia, we offer insight into the prognostic markers. 
 
Tumor size is often the main determinant of stage and treatment. As tumor categories increase, the tumor expands, invading nearby structures [@Zhang]. A study involving 52,287 patients diagnosed between the years 1998 and 2003 found tumor size to be an independent prognostic factor in estimating overall survival. The authors found that patients presenting with larger tumors predicted a worse prognosis and thus are associated with a decrease in survival. There is a similar relationship between extensive lymph node involvement and patient survival [@Zhang]. Initial spread of cancer cells are localized, then become regional, involving nearby lymph nodes and the most severe cases comprises expansion to other organs such as the brain, liver and bones [@Markman].  A study looked at five year survival rates based on the severity of spread. 62.8% of patients with localized spread, 34.8% of patients with regional and 8% of patients with distant, advanced spread were found to survive for 5 years post diagnosis. More than half of these lung cancer patients have advanced spread to other organs when diagnosed [@Markman]. Overall, it is found that patients with no regional lymph node metastases, and smaller tumors are easier to be treated and thus are associated with improved survival rates [@Zhang].

Presence of metastatic LN is one of the most important determinants of prognosis of NSCLC cases [@Kai]. In the early stage, cancer has not spread to lymph nodes. As severity increases, lymph node metastasis sequentially spreads to more distant lymph nodes such as mediastinal and there is severe lymph node involvement [@Park]. Lymph node involvement, also termed lymph node ratio, is a crucial factor in guiding treatment options [@Kai]. A study made up of 97 patients with a mean age of 63 who have undergone surgery between the years 2009 and 2015 in Korea find that increased lymph node involvement is associated with a more advanced disease status and hence affiliated with prognosis [@Park]. Another study looked at 11,341 NSCLC patients between the years 2004 to 2015, from 18 geographically diverse populations, covering approximately 28% of the population of the United States. These patients were treatment naive and underwent surgical resection of the tumor. Although 5757 patients died, the rest showed great results, with a median survival of 22 months [@Kai]. The authors found that patients with low lymph node involvement lead to higher survival compared to patients with high lymph node ratios. A regression analysis revealed that lymph node ratio is an independent and significant predictor of patient survival. The authors also observed that disease burden and anatomical location of the lymph nodes involved may influence the patients survival [@Kai]. 

After tumor size, LN involvement and presence of distant metastasis are categorized, the pathologic stage of the cancer is then determined [@Eldridge]. The most valuable prognostic factor in non-small cell lung cancer is the pathologic stage [@Park] .Stage is determined by tumor size, number of tumors  and where the cancer has spread. Stage 1 is localized spread, stage 2 and 3 is regional spread while stage 4 is distant spread of the tumor [@Eldridge]. Cancer stage was determined using the seventh American Joint Committee on Cancer staging system (AJCC) [@Park]. A study done in Australia including 2119 lung cancer patients illustrated those with stage IV disease, the most advanced stage,  showed shorter survival than those at lower stages [@Denton]. The earlier the cancer is found, that is the lower the pathologic stage, the greater the likelihood curative radiation therapy is an effective treatment [@Eldridge]. However, there is minimal literature looking at post-diagnosis survival rates based on pathologic stage and method of treatment. The extent of this disease illustrates the importance of living a healthy lifestyle, undergoing regular screening and development of improved treatment methods. Over the past decade, there has been great improvement of lymph node assessment in cancer patients [@Kai]. Experts hope survival rates continue to improve with  new therapies and treatment approaches [@Markman]. 

Radiation therapy is a local treatment, targeting the tumor directly, damaging the DNA within cancer cells with the aim of shrinking the tumor. The success rate of radiation therapy treatment is dependent on the location, stage of the cancer as well as individual factors. It is the primary treatment for early stage NSCLC and palliative treatment. Chemotherapy is a systemic therapy utilizing drugs to kill and inhibit cancer cell growth and is often the primary treatment for stage 3 and 4 cancers. NSCLC patients with signs of lymph node metastases have shown great benefit in survival when treated with chemotherapy [@Kai]. A study looking at patients with pathologic stage 3 and 4 NSCLC showed at those who received chemotherapy survived for an average of 10.5 months whereas those that received RT only survived for 3.7 months [@Eldridge]. Patients with early pathologic stages such as 1, 2 and 3 undergo curative treatment. Stage 4, the advanced stage however, is treated as palliative treatment in that the cancer is far too advanced and thus all that can be done is to minimize symptoms and try to improve quality of life. Stage 3b and stage 4 tumors inoperable. Overall, the choice between treatments is made based on assessment of the patient's condition, pathologic stage with tradeoff between providing effective treatment and optimizing quality of life. [@Eldridge].

The remainder of this paper is structured as follows. In @sec-data, we visualize the exploration of variables constituting the pathologic stage and treatment types. @sec-model, outlines the model employed to analyze the relationship between these variables and the duration of survival post-diagnosis. Moreover, @sec-results offers visual depictions of the study's outcomes. Finally, in @sec-discussion, we summarize the primary findings, propose avenues for enhancement, and identify potential areas for future research.

# Data {#sec-data}

## Software and R-packages
This project was created using statistical software, `R` [@citeR]. For data cleaning and manipulation, we used the `tidyverse` [@tidyverse] package, which includes `dplyr` [@dplyr], `readr` [@readr]. Specifically, `readr` was employed for efficient reading of rectangular text data, while `dplyr` facilitated data manipulation tasks such as filtering, summarizing, and joining datasets. 
For unit testing dataset, we utilized the `testthat` [@testthat] package. This allowed us to systematically test our functions and ensure that they behaved as expected across various scenarios. 
In our statistical modeling process, we utilized the `rstanarm` [@rstanarm] package for Bayesian applied regression modeling. This package leverages the Stan probabilistic programming language for efficient computation of Bayesian models, allowing us to perform complex regression analyses while incorporating uncertainty. 
To tidy up and summarize mixed effects models, we employed the `broom.mixed` [@broom.mixed] package. This package provides functions to visualize the results of mixed effects models, making it easier to interpret the findings from such analyses. 
For arranging and combining plots in our visualizations, we utilized the `patchwork` [@patchwork] package. This allowed us to seamlessly arrange multiple plots into a single coherent visual representation, facilitating the communication of complex relationships and patterns in the data.
For aesthetic purposes in our visualizations, we employed the `showtext` [@showtext] package. This enabled us to use a wide range of fonts in our plots, enhancing the visual appeal and customization of our graphical outputs.

## Methodology

The data for this study were collected from a comprehensive database comprising 981 lung cancer patients diagnosed between 1991 to 2013 from `Center for Open Science` [@osf], a dataset acquired in Sydney Australia. The dataset included information on patient demographics, clinical characteristics, treatment modalities, and survival outcomes.

### Data Collection
We obtained data on lung cancer patients meeting the following criteria: histologically confirmed lung cancer diagnosis, availability of complete clinical data, treatment-naive patients, single malignancy and located in Australia. Patients with missing or incomplete information were excluded from the analysis. 

### Data Cleaning
After obtaining the dataset, we selected the columns of interest namely; days to death post diagnosis, presence of distant metastasis, lymph node involvement, pathologic stage, tumor size and treatment type. Next, we renamed the columns, giving them meaningful names and excluded the data containing missing values. This left us with a sample of 382 lung cancer patients. Additionally, we converted the days to death column to numeric.Tests where included to ensure accuracy, reliability and validity of the datset for subsequent analysis and interpretation.

### Data Analysis
Descriptive and inferential statistical analyses were conducted to explore the dataset and derive meaningful insights. These included linear regression modeling, see @sec-model.

## Features
The dataset comprised several key features relevant to lung cancer prognosis, including pathologic stage, presence of distant metastasis, lymph node involvement, tumor size, and treatment type.

```{r}
#| warning: false
#| echo: false
#| message: false
#| label: fig-one
#| fig-cap: Distribution of survival time in patients 

# install.packages
# install.packages("ggplot2")
# install.packages("dplyr")
# install.packages("showtext")
# install.packages("arrow")

# load packages
library(ggplot2)
library(dplyr)
library(showtext)
library(arrow)

### read in data ###
analysis_data <- read_parquet(file = here::here("data/analysis_data/lung_cancer_analysis_data.parquet"))


# Add the desired font (e.g., Patrick Hand)
font_add_google("Patrick Hand", "patrick")

# Set the font for ggplot
showtext_auto()

# Histogram of survival time in days (days_to_death)
ggplot(analysis_data, aes(x = days_to_death)) +
  geom_histogram(binwidth = 50, fill = "forestgreen", color = "black") +
  labs(title = "Distribution of Survival Time in Lung Cancer Patients Post-Diagnosis",
       x = "Days to Death", y = "Frequency") +
  scale_x_continuous(breaks = seq(0, max(analysis_data$days_to_death),
                                  by = 500)) +  # Set breaks every 500 days
  theme_minimal() +
  theme(
    text = element_text(family = "patrick") # Set font to Patrick Hand
  ) 

```

### Days to Death

The main feature analyzed in this study is the duration between the date of lung cancer diagnosis and the date of death, referred to as "days to death." This metric serves as a key indicator of patient survival and provides valuable insights into the disease trajectory and prognosis. By examining the distribution of survival times among lung cancer patients post-diagnosis, we aim to characterize the temporal patterns of disease progression and assess the impact of various clinical factors on survival outcomes. Understanding the time course from diagnosis to death is crucial for guiding treatment decisions, predicting patient outcomes, and identifying opportunities for intervention to improve survival rates. Through comprehensive analysis of days to death data, we seek to elucidate the factors influencing patient survival in lung cancer and contribute to the refinement of prognostic models for clinical practice.

@fig-one illustrates the survival curve for lung cancer patients post-diagnosis where frequency is on the y-axis and survival time in days is on the x-axis. There is a clear trend of a decrease in frequency of survival as time increases. Mortality is most abundant 500 days after diagnosis, that is equivalent to about a year and four months. After about 1500 days, just over four years, the trend line plateus.

@fig-one, the distribution of survival time post-diagnosis suggests that there is a high mortality rate shortly after diagnosis, thus most lung cancer patients die within one year of diagnosis (500 days). There is a steady decline in death and hence incline in survial up until four years (1500 days). The plateu after this indicates that there is a subgroup of patients who survive beyond four years. @sec-results explores which patients had longer survival. 

### pathologic Stage
Pathologic stage, a critical determinant of lung cancer prognosis, was classified according to the TNM (tumor, lymph node, metastasis) Cancer Staging. As depicted in Graph 1 of @fig-two, illustrating the the distribution of pathologic stages with pathologic stage on the x-axis and percentage on the y-axis. The distribution of patients varied across different stages, with the highest proportion of patients diagnosed at StageIB. At this stage, the cancer is still found early however the tumor has regional spread to nearby lymph nodes. Interestingly, at diagnosis, patients had a fairly even spread across the different stages.

### Presence of Distant Metastasis
The presence of distant metastasis, indicative of cancer spread beyond the site of origin to nearby lymph nodes, significantly influences treatment decisions and patient outcomes. Graph 2 of @fig-two illustrates the percentage of patients with distant metastasis where the x-axis is the classification and the y-axis is the percentage of patients. The figure indicates that when patients are diagnosed, most are found in category 'M0' having no distant metastasis and thus cancer has not spread beyond the site of origin. It is important to note that category 'MX', where tumor could not be evaluated has the next largest proportion of patients. Additionally, category 'M1a' appears to show no data however this is because only 1 out of the 382 patients were classified this way. 

### Lymph Node Involvement
Lymph node involvement is another key prognostic factor in lung cancer, reflecting the extent of disease spread to regional lymph nodes. Graph 3 of @fig-two presents the distribution of patients based on lymph node involvement where lymph node involvement is on the x-axis and percentage is on the y-axis. Here, there is a clear trend that as lymph node involvement becomes more severe, the proportion of patients decline. This demonstrates that upon diagnosis, most patients fall under the category 'N0' where there is no regional lymph node metastasis hence cancer has not spread to the lymph nodes. 

### Tumor Size
Tumor size is measured based on the diameter of the primary tumor in lung cancer patients. Graph 4 of @fig-two showcases the distribution of patients across different tumor size categories with tumor size on the x-axis and percentage of patients on the y-axis. The highest proportion of patients were categorized as 'T2' where the tumor is between 3 to 5 centimeters in diameter has grown into the inner lining of the lung, possibly leads to swelling and or collapse of the lung. This category was overwhelmingly more prominent than all others by twofold. All other categories were relatively evenly distributed. 



```{r}
#| warning: false
#| echo: false
#| message: false
#| label: fig-two
#| fig-title: Percentage of Lung Cancer Patients by
#| fig-cap: Percentage of Lung Cancer Patients by Pathologic Stage, Presence of Distant Metastasis, Lymph Node Involvement, Tumor Size


# install.packages("patchwork")

# load packages
library(ggplot2)
library(dplyr)
library(showtext)
library(arrow)
library(patchwork)

### read in data ###
analysis_data <- read_parquet(file = here::here("data/analysis_data/lung_cancer_analysis_data.parquet"))


# Add the desired font (e.g., Patrick Hand)
font_add_google("Patrick Hand", "patrick")

# Set the font for ggplot
showtext_auto()

# create bar chart for pathologic_stage
pathologic_stage_counts <- analysis_data %>%
  group_by(pathologic_stage) %>%
  summarise(count = n ()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  arrange(desc(pathologic_stage))

# create bar chart for presence_of_distant metastasis 
presence_of_distant_metastasis_counts <- analysis_data %>%
  group_by(presence_of_distant_metastasis) %>%
  summarise(count = n ()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  arrange(desc(presence_of_distant_metastasis))

# Define a minimum height for the bars
min_bar_height <- 0.1  # Adjust as needed based on visibility preference

# create bar chart for lymph node involvement 
lymph_node_involvement_counts <- analysis_data %>%
  group_by(lymph_node_involvement) %>%
  summarise(count = n ()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  arrange(desc(lymph_node_involvement))

# create bar chart for tumor size
tumor_size_counts <- analysis_data %>%
  group_by(tumor_size) %>%
  summarise(count = n ()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  arrange(desc(tumor_size))


# Create subplots for all four plots
plots <- list(
  ggplot(pathologic_stage_counts, aes(x = pathologic_stage, y = percentage)) +
    geom_bar(stat = "identity", fill = "lightpink") +
    labs(title = "Graph 1: Pathologic Stage",
         x = "",
         y = "Percentage") +
    theme_minimal() +
    theme(
      text = element_text(family = "patrick"), # Set font to Patrick Hand
      axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels by 45 degrees
    ) +
    scale_y_continuous(breaks = seq(0, max(pathologic_stage_counts$percentage), by = 5)),
  
   ggplot(presence_of_distant_metastasis_counts, aes(x = presence_of_distant_metastasis, y = percentage)) +
    geom_bar(stat = "identity", fill = "gold") +
    labs(title = "Graph 2: Presence of Distant Metastasis",
         x = "",
         y = "") +  # Remove y-axis label 
    theme_minimal() +
    theme(
      text = element_text(family = "patrick"), # Set font to Patrick Hand
      axis.title.y = element_blank(), # Remove y-axis title
    ),

   ggplot(lymph_node_involvement_counts, aes(x = lymph_node_involvement, y = percentage)) +
    geom_bar(stat = "identity", fill = "cyan") +
    labs(title = "Graph 3: Lymph Node Involvement",
         x = "",
         y = "Percentage") +  # Keep y-axis label for this plot
    theme_minimal() +
    theme(
      text = element_text(family = "patrick") # Set font to Patrick Hand
    ) +
    scale_y_continuous(breaks = seq(0, max(lymph_node_involvement_counts$percentage), by = 10)),
  
  ggplot(tumor_size_counts, aes(x = tumor_size, y = percentage)) +
    geom_bar(stat = "identity", fill = "purple") +
    labs(title = "Graph 4: Tumor Size",
         x = "",
         y = "") +  # Remove y-axis label 
    theme_minimal() +
    theme(
      text = element_text(family = "patrick"), # Set font to Patrick Hand
      axis.title.y = element_blank() # Remove y-axis title
    ) + guides(color = guide_legend(title.position = "top", title.vjust = 0.5))  
    # Adjust legend title position
    
) 

# Combine plots using patchwork and largen the dimensions
plots_combined <- wrap_plots(plots, ncol = 2, height = 12, width = 14)


# Print combined plots
plots_combined


```


# Model {#sec-model}

## Model set-up

In this section, we aim to predict the survival outcomes of lung cancer patients post-diagnosis with a linear regression model framework. We consider several predictors including pathologic stage, lymph node involvement, presence of distant metastasis, tumor size, and treatment type.We specify the model and subsequently justify its appropriateness for our analysis.

### Model Specifications ###

We employ a linear regression model to predict the number of days from diagnosis to death for each lung cancer patient. The model is defined as follows:
\begin{align*}
y_i \mid \mu_i, \sigma &\sim \text{Normal}(\mu_i, \sigma)
\end{align*}
where:

- $y_i$ represents the number of days from diagnosis to death for patient $i$.
- $\mu_i$ denotes the expected number of days to death for patient $i$.
- $\sigma$ represents the standard deviation of the survival times.

The linear predictor $\mu_i$ is specified as:
\begin{align*}
y_i \mid \mu_i, \sigma &\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_{\text{pathologic\_stage}} \times \text{pathologic\_stage}_i \\
&\quad + \beta_{\text{lymph\_node}} \times \text{lymph\_node\_involvement}_i \\
&\quad + \beta_{\text{metastasis}} \times \text{presence\_of\_distant\_metastasis}_i \\
&\quad + \beta_{\text{tumor\_size}} \times \text{tumor\_size}_i \\
&\quad + \beta_{\text{treatment\_type}} \times \text{treatment\_type}_i
\end{align*}
where:

- $\alpha$ represents the intercept term, capturing the baseline number of days to death.
- $\beta$ {\text{pathologic\_stage}}, $\beta$ {\text{lymph\_node}}, $\beta$ {\text{metastasis}}, $\beta$ {\text{tumor\_size}}, $\beta$ {\text{treatment\_type}} are the coefficients associated with each predictor variable.

### Model justification

Linear regression models are most appropritate in predicting continuous outcomes. As survival time is continuous, this model allows us to quantify the relationships between these predictors and survival outcomes, providing valuable insights into the factors influencing the prognosis of lung cancer patients.

#### Response Variable ####

Out variable of interest is survival time in lung cancer patient afte they have been diagnosed

We model the survival time ($y_i$) as a continuous variable, reflecting the duration from diagnosis to death for each patient. This continuous characterization is appropriate for capturing the temporal aspect of survival outcomes in medical contexts.

#### Input Variables ####

We consider several clinically relevant predictors including pathologic stage, lymph node involvement, presence of distant metastasis, tumor size, and treatment type. These variables are chosen based on their established associations with lung cancer prognosis, encompassing key aspects of disease severity and treatment strategies.

#### Model Structure #####

The linear regression model relates the expected survival time ($Î¼_i$) to the linear combination of predictor variables, allowing us to quantify the impact of each predictor on the expected duration of survival. This framework facilitates interpretation of the associations between clinical variables and survival outcomes, providing valuable insights for patient prognosis.

#### Parameter Estimation ####

We anticipate that the survival time of lung cancer patients post-diagnosis will be influenced by various clinical factors such as pathologic stage, extent of lymph node involvement, presence of distant metastasis, tumor size, and treatment type. Specifically, we expect that advanced pathologic stages, increased lymph node involvement, presence of distant metastasis, larger tumor sizes, and certain treatment types will be associated with shorter survival times.

We run the model in R [@citeR] estimating the model coefficients ($\alpha$ and $\beta$) using Bayesian inference via the 'stan_glm()' function from the @rstanarm package. This approach leverages Markov Chain Monte Carlo (MCMC) algorithms to obtain posterior distributions for the model parameters, enabling robust estimation of parameter uncertainties and inference on the effects of predictor variables.


# Results {#sec-results}

Our results are summarized in @.

```{r}
##| echo: false
#| eval: true
#| warning: false
#| message: false

# install.packages
# install.packages("reshape2")
# install.packages("vcd")

# Load required libraries
library(ggplot2)
library(arrow)
library(dplyr)
library(showtext)
library(reshape2)
library(vcd)
library(patchwork)

### read in data ###
analysis_data <- read_parquet(file = here::here("data/analysis_data/lung_cancer_analysis_data.parquet"))

# Add the desired font (e.g., Patrick Hand)
font_add_google("Patrick Hand", "patrick")

# Set the font for ggplot
showtext_auto()

# Create a scatter plot with trend lines - pathologic stage vs. time vs. treatment type
ggplot(data = analysis_data, aes(x = days_to_death, y = pathologic_stage, color = treatment_type)) +
  geom_point(size = 2.5, alpha = 0.6, shape = 19) +  
  # Adjusted point size and transparency
  geom_smooth(method = "lm", se = FALSE, aes(group = treatment_type), alpha = 0.3) +  
  # Adjust trend line transparency
  scale_color_manual(values = c("Pharmaceutical Therapy, NOS" = "blue", "Radiation Therapy, NOS" = "green")) +
  labs(x = "Days to Death", y = "Pathologic Stage", color = "Treatment Type") +
  scale_x_continuous(breaks = seq(0, max(analysis_data$days_to_death),
                                  by = 500))+  # Set breaks on x-axis
  theme_minimal() +
  theme(text = element_text(family = "patrick", size = 14), 
        # Set font to Patrick Hand and increase the size
      legend.position = "bottom", legend.text = element_text(size = 12)) +  
  # Adjust legend position and text size
  guides(color = guide_legend(title.position = "top", title.vjust = 0.5))  
  # Adjust legend title position

# Create a scatter plot with trend lines - presence of distant metastasis vs. time vs. treatment type
ggplot(data = analysis_data, aes(x = days_to_death, y = presence_of_distant_metastasis, color = treatment_type)) +
  geom_point(size = 2.5, alpha = 0.6, shape = 19) +  
  # Adjusted point size and transparency
  geom_smooth(method = "lm", se = FALSE, aes(group = treatment_type), alpha = 0.3) +  
  # Adjust trend line transparency
  scale_color_manual(values = c("Pharmaceutical Therapy, NOS" = "blue", "Radiation Therapy, NOS" = "green")) +
  labs(x = "Days to Death", y = "Presence of Distant Metastasis", color = "Treatment Type") +
  scale_x_continuous(breaks = seq(0, max(analysis_data$days_to_death),
                                  by = 500)) +  # Set breaks on x-axis
  theme_minimal() +
  theme(text = element_text(family = "patrick", size = 14), 
        # Set font to Patrick Hand
      legend.position = "bottom", legend.text = element_text(size = 12)) +  
  # Adjust legend position and text size
  guides(color = guide_legend(title.position = "top", title.vjust = 0.5))  
  # Adjust legend title position

# Create a scatter plot with trend lines - lymph node involvement vs. time vs. treatment type
ggplot(data = analysis_data, aes(x = days_to_death, y = lymph_node_involvement, color = treatment_type)) +
  geom_point(size = 2.5, alpha = 0.6, shape = 19) +  
  # Adjusted point size and transparency
  geom_smooth(method = "lm", se = FALSE, aes(group = treatment_type), alpha = 0.3) +  
  # Adjust trend line transparency
  scale_color_manual(values = c("Pharmaceutical Therapy, NOS" = "blue", "Radiation Therapy, NOS" = "green")) +
  labs(x = "Days to Death", y = "Lymph Node Involvement", color = "Treatment Type") +
  scale_x_continuous(breaks = seq(0, max(analysis_data$days_to_death),
                                  by = 500)) +  # Set breaks on x-axis
  theme_minimal() +
  theme(text = element_text(family = "patrick", size = 14), # Set font to Patrick Hand
      legend.position = "bottom", legend.text = element_text(size = 12)) +  
  # Adjust legend position and text size
  guides(color = guide_legend(title.position = "top", title.vjust = 0.5))  
  # Adjust legend title position

# Create a scatter plot with trend lines - tumor size vs. time vs. treatment type
ggplot(data = analysis_data, aes(x = days_to_death, y = tumor_size, color = treatment_type)) +
  geom_point(size = 2.5, alpha = 0.6, shape = 19) +  
  # Adjusted point size and transparency
  geom_smooth(method = "lm", se = FALSE, aes(group = treatment_type), alpha = 0.3) +  
  # Adjust trend line transparency
  scale_color_manual(values = c("Pharmaceutical Therapy, NOS" = "blue", "Radiation Therapy, NOS" = "green")) +
  labs(x = "Days to Death", y = "Tumor Size", color = "Treatment Type") +
  scale_x_continuous(breaks = seq(0, max(analysis_data$days_to_death),
                                  by = 500)) +  # Set breaks on x-axis
  theme_minimal() +
  theme(text = element_text(family = "patrick", size = 14), # Set font to Patrick Hand
      legend.position = "bottom", legend.text = element_text(size = 12)) +  
  # Adjust legend position and text size
  guides(color = guide_legend(title.position = "top", title.vjust = 0.5))  
  # Adjust legend title position


```


```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

# install.packages
# install.packages("reshape2")
# install.packages("vcd")

# Load required libraries
library(ggplot2)
library(arrow)
library(dplyr)
library(reshape2)
library(vcd)

### read in data ###
analysis_data <- read_parquet(file = here::here("data/analysis_data/lung_cancer_analysis_data.parquet"))

# Create a ggplot2 plot for pathologic_stage and treatment_type with adjusted margins, legend, and horizontal y-axis labels
ggplot(analysis_data, aes(x = pathologic_stage, fill = treatment_type)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_blank(), axis.text.y = element_text(angle = 0, hjust = 1)) +
  scale_fill_manual(name = "Treatment Type", values = c("Pharmaceutical Therapy, NOS" = "blue", "Radiation Therapy, NOS" = "red"))




```





```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Load required libraries
library(ggplot2)
library(arrow)

### read in data ###
analysis_data <- read_parquet(file = here::here("data/analysis_data/lung_cancer_analysis_data.parquet"))


# Scatter plot survival time vs. pathologic stage - to compare survival probabilities
ggplot(analysis_data, aes(x = pathologic_stage, y = days_to_death)) +
  geom_point(size = 3, color = "lightpink") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Survival Time vs. Pathologic Stage Post-Diagnosis",
       x = "Pathologic Stage",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  # Rotate x-axis labels for better readability
  theme(text = element_text(family = "patrick") 
  # Set font to Patrick Hand
  )

# Line graph with trend lines 
ggplot(analysis_data, aes(x = pathologic_stage, y = days_to_death)) +
  geom_line(color = "blue", group = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Days to Death vs. Pathologic Stage for Lung Cancer Patients",
       x = "Pathologic Stage",
       y = "Days to Death") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability


# not sure what this is 
# Plotting
ggplot(analysis_data, aes(x = days_to_death, fill = pathologic_stage)) +
  geom_density(alpha = 0.5) +
  geom_density(color = "black", size = 1.5) +
  labs(title = "Density Plot of Days to Death by Pathologic Stage for Lung Cancer Patients",
       x = "Days to Death",
       y = "Density") +
  scale_fill_manual(values = c("lightgreen", "lightgreen", "lightgreen","forestgreen", "forestgreen", "forestgreen", "darkgreen","darkgreen", "darkgreen", "red")) +
  theme_minimal()


# not sure .2
ggplot(analysis_data, aes(x = days_to_death, fill = pathologic_stage)) +
  geom_density(alpha = 0.5) +
  geom_density(color = "black", size = 1.5) +
  labs(title = "Density Plot of Days to Death by Pathologic Stage for Lung Cancer Patients",
       x = "Days to Death",
       y = "Density") +
  scale_fill_manual(values = c("lightgreen", "lightgreen", "lightgreen","forestgreen", "forestgreen", "forestgreen", "darkgreen","darkgreen", "darkgreen", "red")) +
  theme_minimal() +
  facet_wrap(~pathologic_stage, scales = "free")


# Boxplot 
ggplot(analysis_data, aes(x = pathologic_stage, y = days_to_death)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Survial Distribution Post-Diagnosis by Pathologic Stage",
       x = "Pathologic Stage",
       y = "Days to Death") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability


######################################


# Scatter plot survival time vs. Presence of Distant Metastasis
ggplot(analysis_data, aes(x = presence_of_distant_metastasis, y = days_to_death)) +
  geom_point(size = 3, color = "gold") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Survival Time vs. Presence of Distant Metastasis Post-Diagnosis",
       x = "Presence of Distant Metastasis",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  # Rotate x-axis labels for better readability
  theme(text = element_text(family = "patrick") 
  # Set font to Patrick Hand
  )

# Scatter plot survival time vs. Lymph node involvement
ggplot(analysis_data, aes(x = lymph_node_involvement, y = days_to_death)) +
  geom_point(size = 3, color = "cyan") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Survival Time vs. Lymph Node Involvement Post-Diagnosis",
       x = "Lymph Node Involvement",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  # Rotate x-axis labels for better readability
  theme(text = element_text(family = "patrick") 
  # Set font to Patrick Hand
  )

# Scatter plot survival time vs. Tumor Size
ggplot(analysis_data, aes(x = tumor_size, y = days_to_death)) +
  geom_point(size = 3, color = "purple") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Survival Time vs. Tumor Size Post-Diagnosis",
       x = "Tumor Size",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  # Rotate x-axis labels for better readability
  theme(text = element_text(family = "patrick") 
  # Set font to Patrick Hand
  )

#########################

# Scatter plot survival time vs. Treatment Type
ggplot(analysis_data, aes(x = treatment_type, y = days_to_death)) +
  geom_point(size = 3, color = "cyan") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  
  # Add a linear trend line
  labs(title = "Survival Time vs. Treatment Type Post-Diagnosis",
       x = "Treatment Type",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  # Rotate x-axis labels for better readability
  theme(text = element_text(family = "patrick") 
  # Set font to Patrick Hand
  )

# Grouped bar chart for survival time vs. Treatment Type
ggplot(analysis_data, aes(x = treatment_type, y = days_to_death, fill = treatment_type)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  labs(title = "Average Survival Time by Treatment Type Post-Diagnosis",
       x = "Treatment Type",
       y = "Average Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand

# Horizontal grouped bar chart for survival time vs. Treatment Type
ggplot(analysis_data, aes(y = treatment_type, x = days_to_death, fill = treatment_type)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge", orientation = "horizontal") +
  labs(title = "Average Survival Time by Treatment Type Post-Diagnosis",
       y = "Treatment Type",
       x = "Average Survival Time (days)") +
  theme_minimal() +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand

# Grouped dot plot for survival time vs. Treatment Type
ggplot(analysis_data, aes(x = treatment_type, y = days_to_death, color = treatment_type)) +
  geom_jitter(position = position_dodge(width = 0.5), size = 3, alpha = 0.7) +
  labs(title = "Survival Time by Treatment Type Post-Diagnosis",
       x = "Treatment Type",
       y = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand


# Grouped dot plot with flipped axes for survival time vs. Treatment Type
ggplot(analysis_data, aes(y = treatment_type, x = days_to_death, color = treatment_type)) +
  geom_jitter(position = position_dodge(width = 0.5), size = 3, alpha = 0.7) +
  labs(title = "Survival Time by Treatment Type Post-Diagnosis",
       y = "Treatment Type",
       x = "Survival Time (days)") +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1)) +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand

# Stacked bar chart for treatment method vs. Average Survival Time
ggplot(analysis_data, aes(x = days_to_death, fill = treatment_type)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Treatment Methods by Average Survival Time Post-Diagnosis",
       x = "Average Survival Time (days)",
       y = "Proportion of Patients") +
  scale_fill_manual(values = c("cyan", "magenta")) + # Adjust fill colors
  theme_minimal() +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand

# Stacked bar chart for treatment method vs. Average Survival Time
ggplot(analysis_data, aes(x = days_to_death, fill = treatment_type)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Treatment Methods by Average Survival Time Post-Diagnosis",
       x = "Average Survival Time (days)",
       y = "Proportion of Patients") +
  scale_fill_manual(values = c("cyan", "magenta")) + # Adjust fill colors
  scale_x_continuous(expand = c(0, 0)) + # Adjust x-axis limits
  theme_minimal() +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand


# Stacked bar chart for treatment method vs. Average Survival Time
ggplot(analysis_data, aes(x = days_to_death, fill = treatment_type)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Treatment Methods by Average Survival Time Post-Diagnosis",
       x = "Average Survival Time (days)",
       y = "Proportion of Patients") +
  scale_fill_manual(values = c("cyan", "magenta")) + # Adjust fill colors
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(analysis_data$days_to_death))) + # Adjust x-axis limits
  theme_minimal() +
  theme(text = element_text(family = "patrick")) 
  # Set font to Patrick Hand


# Boxplot 
ggplot(analysis_data, aes(x = treatment_type, y = days_to_death)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Survial Distribution Post-Diagnosis by Treatment Type",
       x = "Treatment Type",
       y = "Days to Death") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability


```


# Discussion {#sec-discussion}

## First discussion point {#sec-first-point}

## Second discussion point

## Third discussion point

## Weaknesses and next steps



\newpage

\appendix

# Appendix {#sec-appendix}


# Additional data details

# Model details {#sec-model-details}
we compare the posterior with the prior. This shows... 

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]


```

## Diagnostics
Is this needed?

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2


```



\newpage


# References


